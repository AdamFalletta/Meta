<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFI Solutions Admin Console</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#1f2937', // gray-800
                        'secondary-dark': '#111827', // gray-900
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better look in dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Sidebar item styling */
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            border-radius: 0.5rem;
            margin: 0 0.5rem;
        }
        .sidebar-item:hover {
            background-color: rgba(75, 85, 99, 0.2); /* gray-600 with opacity */
        }
        .sidebar-item.active {
            background-color: rgba(30, 64, 175, 0.4); /* blue-700 with opacity */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .sidebar-item-label {
            margin-left: 1rem;
            color: #d1d5db; /* gray-300 */
        }

        /* Mobile Menu Overlay */
        #mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40; /* Above sidebar */
            display: none;
        }

        .tool-btn {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            text-sm font-medium;
            color: white;
            rounded-md;
            transition: all 0.15s ease-in-out;
            text-align: center;
        }
        
        /* Responsive Layout Grid */
        @media (max-width: 767px) {
            #sidebar {
                position: fixed;
                left: -100%;
                transition: left 0.3s ease-in-out;
                z-index: 50;
                height: 100%;
                overflow-y: auto;
            }
            #sidebar.open {
                left: 0;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.5);
            }
        }
    </style>
</head>
<body class="bg-secondary-dark text-white font-sans flex h-screen overflow-hidden">

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" onclick="closeSidebar()"></div>

    <!-- 1. Sidebar -->
    <aside id="sidebar" class="w-64 bg-primary-dark flex-shrink-0 md:relative absolute transition-all duration-300">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-extrabold text-sky-400">AFI Console</h1>
            <p class="text-xs text-gray-500 mt-1">Management System</p>
        </div>
        <nav id="nav-list" class="p-3 space-y-2 overflow-y-auto" style="height: calc(100vh - 7rem);">
            <!-- Navigation links rendered by JS -->
        </nav>
    </aside>

    <!-- 2. Main Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Main Header (Visible on Desktop, has Menu Button on Mobile) -->
        <header class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700 bg-primary-dark flex-shrink-0 z-10">
            <div class="flex items-center">
                <button id="menu-toggle" class="md:hidden text-gray-300 hover:text-white mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </button>
                <h2 id="page-title" class="text-xl md:text-2xl font-semibold text-white">Dashboard</h2>
            </div>
            <div class="flex space-x-4 items-center">
                <span class="text-sm text-gray-400 hidden md:block">User: Admin (UID: <span id="user-id">Loading...</span>)</span>
                <button onclick="navigate('Settings')" class="text-gray-400 hover:text-sky-400 p-2 rounded-full transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.09a2 2 0 0 0-2.73.73l-.26.43a2 2 0 0 0-.17 2v.44a2 2 0 0 0 1 1.73l.43.25a2 2 0 0 1 0 2.73l-.43.25a2 2 0 0 0-1 1.73v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.09a2 2 0 0 0 2.73-.73l.26-.43a2 2 0 0 0 .17-2v-.44a2 2 0 0 0-1-1.73l-.43-.25a2 2 0 0 1 0-2.73l.43-.25a2 2 0 0 0 1-1.73V4a2 2 0 0 0-2-2h-.44zm.22 10a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></svg>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8">
            <!-- Content will be rendered here by JS -->
            <div class="text-center text-gray-500 py-20">
                <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 5h16M4 19h16"/></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-400">Loading Content</h3>
                <p class="mt-1 text-sm text-gray-500">Please select a module from the sidebar.</p>
            </div>
        </div>
    </main>

    <script>
        // --- DATA SETUP ---
        const departmentModules = [
            { id: '1', name: 'Client Management', icon: 'UserPlus', color: 'indigo-500', description: 'Handles client profiles, subscriptions, and support tickets.' },
            { id: '2', name: 'Order & Billing', icon: 'Receipt', color: 'cyan-500', description: 'Tracks purchases, invoices, recurring payments, and deployment statuses.' },
            { id: '3', name: 'Deployment Control', icon: 'Gauge', color: 'emerald-500', description: 'Oversees install pipelines, provisioning, and version updates.' },
            { id: '4', name: 'System Health', icon: 'Activity', color: 'rose-500', description: 'Monitors uptime, performance, logs, and telemetry across devices.' },
            { id: '5', name: 'Inventory & Asset', icon: 'Boxes', color: 'yellow-500', description: 'Manages physical devices, licenses, and configurations for field deployments.' },
            { id: '6', name: 'AI/LLM Hub', icon: 'Brain', color: 'purple-500', description: 'Central connector for local Ollama models, cloud LLM APIs, and dataset sync.' },
            { id: '7', name: 'Marketing & Sales', icon: 'TrendingUp', color: 'pink-500', description: 'Manages outreach campaigns, prospect tracking, and partner programs.' },
            { id: '8', name: 'Product Development', icon: 'ClipboardList', color: 'orange-500', description: 'Internal R&D lab: manage prototypes, app versions, changelogs, and documents.' },
            { id: '9', name: 'UX Feedback Loop', icon: 'Smile', color: 'lime-500', description: 'Collects UX data, analytics, feedback forms, and behavior tracking.' },
            { id: '10', name: 'Security & Access', icon: 'Lock', color: 'blue-500', description: 'Role-based access, authentication, encryption, and audit logging.' },
            { id: '11', name: 'API Gateway', icon: 'KeySquare', color: 'sky-500', description: 'Manages integrations, plugins (like CloudPress), REST/GraphQL APIs.' },
            { id: '12', name: 'Finance & Insights', icon: 'LineChart', color: 'red-500', description: 'Business intelligence, revenue analytics, KPIs, forecasting, and financial reporting.' },
        ];
        
        // Mock Data Storage (in-memory for this example)
        let appData = {
            'Client Management': [
                { id: 'CL-001', title: 'New Onboarding for Acme Corp', status: 'New', priority: 'High', created: Date.now() - 86400000, details: 'Setup initial credentials and monitor first deployment.' },
                { id: 'CL-002', title: 'Support Ticket #452: Connection issue', status: 'In Progress', priority: 'Medium', created: Date.now() - 3600000, details: 'Investigate dropped connections in their Europe cluster.' },
            ],
            'Order & Billing': [
                { id: 'OB-203', title: 'Q4 2024 Invoice Generation', status: 'Completed', priority: 'Low', created: Date.now() - 2592000000, details: 'Final review and mass sending of quarterly invoices.' },
            ],
            'Deployment Control': [
                { id: 'DC-901', title: 'Rollout of v1.5.0 to staging', status: 'In Progress', priority: 'Urgent', created: Date.now() - 600000, details: 'Monitoring staggered rollout to 10% of test clients.' },
            ],
        };

        let currentState = {
            page: 'Home', // 'Home', 'Settings', 'ModuleDetail', 'ViewEntry', 'CreateEntry'
            moduleId: null,
            entryId: null
        };
        
        // Firestore variables (mandatory for real-world apps, mocked here as placeholders)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const currentUserId = 'AUTH-12345'; // Mocked User ID

        // --- DOM REFERENCES ---
        const navList = document.getElementById('nav-list');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        const overlay = document.getElementById('mobile-menu-overlay');
        const userIdSpan = document.getElementById('user-id');

        // --- UTILITY FUNCTIONS ---

        /** Generates a simple SVG icon based on name. */
        function getIconSvg(name, size = 20, stroke = 2, className = 'text-gray-300') {
            // Updated icons to include 'Reply' for back button
            const icons = {
                Home: `<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/>`,
                UserPlus: `<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>`,
                Receipt: `<rect x="3" y="6" width="18" height="13" rx="2"/><path d="M12 18V8"/><path d="M9 11h6"/>`,
                Gauge: `<path d="M12 2v20"/><path d="M17 5H7l5-5 5 5zM7 19h10l-5 5-5-5z"/>`,
                Activity: `<path d="M14 9l-6 6M8 9l6 6"/><circle cx="12" cy="12" r="10"/>`,
                Boxes: `<rect x="2" y="7" width="20" height="15" rx="2"/><path d="M12 2v5"/><path d="M12 11v-4"/>`,
                Brain: `<path d="M12 5c2.3 0 4.2 1.9 4.2 4.2v6.3c0 2.3-1.9 4.2-4.2 4.2S7.8 17.5 7.8 15.3V9.2C7.8 6.9 9.7 5 12 5zM12 5a4.2 4.2 0 0 0-4.2-4.2M12 5a4.2 4.2 0 0 1 4.2-4.2"/><path d="M22 10.3c0 3.3-2.7 6-6 6"/><path d="M2 10.3c0 3.3 2.7 6 6 6"/><path d="M12 22a10 10 0 0 0 0-20"/>`,
                TrendingUp: `<polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/>`,
                ClipboardList: `<rect x="3" y="2" width="18" height="20" rx="2"/><path d="M9 12h6M9 16h6M8 8h.01M16 8h.01"/>`,
                Smile: `<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/>`,
                Lock: `<rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>`,
                KeySquare: `<path d="M10 3H7a2 2 0 0 0-2 2v2M14 21h3a2 2 0 0 0 2-2v-3M3 14v3a2 2 0 0 0 2 2h3M21 10V7a2 2 0 0 0-2-2h-3"/><circle cx="12" cy="12" r="4"/><path d="m14 14-2-2"/>`,
                LineChart: `<path d="M3 3v18h18"/><path d="M18 17l-5.01-5.01L8.5 15 3 9"/>`,
                Settings: `<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.09a2 2 0 0 0-2.73.73l-.26.43a2 2 0 0 0-.17 2v.44a2 2 0 0 0 1 1.73l.43.25a2 2 0 0 1 0 2.73l-.43.25a2 2 0 0 0-1 1.73v.44a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.09a2 2 0 0 0 2.73-.73l.26-.43a2 2 0 0 0 .17-2v-.44a2 2 0 0 0-1-1.73l-.43-.25a2 2 0 0 1 0-2.73l.43-.25a2 2 0 0 0 1-1.73V4a2 2 0 0 0-2-2h-.44zm.22 10a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/>`,
                Plus: `<path d="M12 5v14M5 12h14"/>`,
                Reply: `<path d="M10 20L3 13l7-7"/><path d="M21 13H4"/>`,
                Trash: `<path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>`,
                Info: `<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>`,
            };
            const path = icons[name] || icons.Info;

            return `
                <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${stroke}" stroke-linecap="round" stroke-linejoin="round" class="${className}">
                    ${path}
                </svg>
            `;
        }
        
        // --- NAVIGATION & LAYOUT ---

        function openSidebar() {
            sidebar.classList.add('open');
            overlay.style.display = 'block';
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.style.display = 'none';
        }

        /** Handles all page navigation and content rendering based on state. */
        function navigate(page, params = {}) {
            currentState.page = page;
            currentState.moduleId = params.moduleId || null;
            currentState.entryId = params.entryId || null;

            // Set page title and handle content rendering
            let title = page;
            switch(page) {
                case 'Home': title = 'Dashboard'; renderDashboard(); break;
                case 'Settings': renderSettings(); break;
                case 'ModuleDetail': title = currentState.moduleId; renderModuleDetail(currentState.moduleId); break;
                case 'ViewEntry': title = `Entry: ${currentState.entryId}`; renderEntryView(currentState.moduleId, currentState.entryId); break;
                case 'CreateEntry': title = `New Entry in ${currentState.moduleId}`; renderCreateEntry(currentState.moduleId); break;
                default: renderDashboard(); break;
            }
            pageTitle.textContent = title;
            renderNavigation();

            // Close sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                closeSidebar();
            }
        }

        /** Renders the main sidebar navigation links. */
        function renderNavigation() {
            // Clear existing
            navList.innerHTML = '';
            
            // 1. Dashboard Link
            const dashboardItem = createNavItem('Dashboard', 'Home', 'text-sky-400', 'Home');
            navList.appendChild(dashboardItem);
            
            // 2. Modules Header
            const header = document.createElement('div');
            header.className = 'uppercase text-xs font-semibold tracking-wider text-gray-400 mt-4 px-3 mb-1 pt-4 border-t border-gray-700';
            header.textContent = 'Modules';
            navList.appendChild(header);

            // 3. Module Links
            departmentModules.forEach(module => {
                const item = createNavItem(module.name, 'ModuleDetail', module.color, module.icon, { moduleId: module.name });
                navList.appendChild(item);
            });
        }
        
        /** Helper to create a single navigation item element. */
        function createNavItem(name, page, colorClass, iconName = 'Home', params = {}) {
            const item = document.createElement('div');
            
            // Determine if this item is currently active
            let isActive = false;
            if (page === 'Home' && currentState.page === 'Home') isActive = true;
            if (page === 'Settings' && currentState.page === 'Settings') isActive = true;
            if ((page === 'ModuleDetail' || page === 'ViewEntry' || page === 'CreateEntry') && currentState.moduleId === params.moduleId) isActive = true;

            item.className = 'sidebar-item rounded-lg ' + (isActive ? 'active' : 'hover:bg-gray-700');
            item.onclick = () => navigate(page, params);

            const iconSvg = getIconSvg(iconName, 20, 2, 'text-' + colorClass);
            
            item.innerHTML = `
                ${iconSvg}
                <span class="sidebar-item-label text-sm font-medium transition duration-150">${name}</span>
            `;

            return item;
        }


        // --- CONTENT RENDERERS ---

        function renderDashboard() {
            // ... (Dashboard rendering logic remains the same)
             contentArea.innerHTML = `
                <h1 class="text-4xl font-extrabold text-white mb-8 tracking-tight">System Dashboard</h1>
                <p class="text-gray-400 mb-8">Welcome to the AFI Solutions Management System Admin Console. Below is a summary of all active modules.</p>

                <div class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                    ${departmentModules.map(module => `
                        <div class="p-6 bg-primary-dark rounded-xl shadow-xl border border-gray-700 flex flex-col justify-between cursor-pointer hover:border-sky-500 transition duration-300" 
                             onclick="navigate('ModuleDetail', { moduleId: '${module.name}' })">
                            <div>
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="p-3 rounded-full bg-opacity-20 ${module.color.replace('-500', '-900')}">
                                        ${getIconSvg(module.icon, 24, 2, 'text-' + module.color)}
                                    </div>
                                    <h3 class="text-xl font-semibold text-white">${module.name}</h3>
                                </div>
                                <p class="text-sm text-gray-400">${module.description}</p>
                            </div>
                            <div class="mt-4 flex justify-between items-center text-sm">
                                <span class="text-gray-500">Active Entries:</span>
                                <span class="font-bold text-lg text-sky-400">${(appData[module.name] || []).length}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderSettings() {
            // ... (Settings rendering logic remains the same)
             contentArea.innerHTML = `
                <h1 class="text-4xl font-extrabold text-white mb-8 tracking-tight">System Settings</h1>
                <div class="bg-primary-dark p-6 rounded-xl shadow-xl border border-gray-700 max-w-2xl">
                    <h3 class="text-xl font-semibold text-white mb-4">API Configuration</h3>
                    <p class="text-gray-400 mb-6">Manage global API keys and service endpoints.</p>

                    <div class="space-y-4">
                        <div>
                            <label for="api-key" class="block text-sm font-medium text-gray-400">Master API Key</label>
                            <input type="password" id="api-key" value="••••••••••••••••••••" readonly
                                class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-white shadow-sm p-3">
                        </div>
                        <div>
                            <label for="endpoint" class="block text-sm font-medium text-gray-400">LLM Endpoint URL</label>
                            <input type="url" id="endpoint" value="https://api.afi-solutions.com/v1/llm-gateway" readonly
                                class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-white shadow-sm p-3">
                        </div>
                    </div>
                    <button onclick="console.log('Revoke all tokens action triggered.')" class="mt-6 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-150">
                        Revoke All Tokens
                    </button>
                </div>
            `;
        }

        /** Renders the dedicated page for viewing and editing a specific entry. */
        function renderEntryView(moduleName, entryId) {
            const entry = (appData[moduleName] || []).find(e => e.id === entryId);
            if (!entry) {
                 contentArea.innerHTML = `<p class="text-red-400">Error: Entry ${entryId} not found in ${moduleName}.</p>`;
                 return;
            }

            const moduleInfo = departmentModules.find(m => m.name === moduleName);

            contentArea.innerHTML = `
                <div class="flex items-center mb-6">
                    <button onclick="navigate('ModuleDetail', { moduleId: '${moduleName}' })" 
                            class="flex items-center text-gray-400 hover:text-sky-400 transition duration-150 mr-4">
                        ${getIconSvg('Reply', 20, 2, 'text-current')}
                        <span class="ml-2 hidden sm:inline">Back to ${moduleName}</span>
                    </button>
                    <h1 class="text-4xl font-extrabold text-white tracking-tight">${entry.title}</h1>
                    <span class="ml-4 px-3 py-1 text-sm font-bold rounded-full bg-gray-700 text-gray-300">${entry.id}</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- General Details Card -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Edit Form Section -->
                        <div class="bg-primary-dark p-6 rounded-xl shadow-xl border border-gray-700">
                            <h2 class="text-2xl font-semibold text-sky-400 mb-4">Edit Entry Details</h2>
                            ${renderEntryForm(entry, moduleName, true)}
                        </div>

                         <!-- Detailed Description Card -->
                        <div class="bg-primary-dark p-6 rounded-xl shadow-xl border border-gray-700">
                            <h2 class="text-xl font-semibold text-white mb-4">Entry Notes & Details</h2>
                            <p class="text-gray-400 whitespace-pre-wrap">${entry.details}</p>
                            <p class="text-xs text-gray-500 mt-4">Created: ${new Date(entry.created).toLocaleString()}</p>
                        </div>
                    </div>

                    <!-- Module Tools Card -->
                    <div class="lg:col-span-1">
                        <div class="bg-primary-dark p-6 rounded-xl shadow-xl border border-gray-700 sticky top-4">
                            ${renderModuleTools(moduleName, entry.id)}
                            
                            <button onclick="deleteEntry('${moduleName}', '${entry.id}', '${entry.title}')" 
                                class="tool-btn bg-red-600 hover:bg-red-700 mt-6">
                                Delete Entry
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Attach form listener dynamically
            document.getElementById('entry-form').addEventListener('submit', handleEntrySubmission);
        }

        /** Renders module-specific UI tools for context-driven administrative actions. */
        function renderModuleTools(moduleName, entryId) {
            let toolsHtml = '';
            let toolTitle = 'General Actions';
            
            switch (moduleName) {
                case 'Client Management':
                    toolTitle = 'Client Provisioning Tools';
                    toolsHtml = `
                        <p class="text-sm text-gray-400 mb-4">Actions for client onboarding and data management.</p>
                        <div class="space-y-3">
                            <button onclick="console.log('Action: Generate Contract for ${entryId}')" class="tool-btn bg-purple-600 hover:bg-purple-700">Generate Contract PDF</button>
                            <button onclick="console.log('Action: Trigger Data Sync for ${entryId}')" class="tool-btn bg-indigo-600 hover:bg-indigo-700">Trigger Force Data Sync</button>
                        </div>
                    `;
                    break;
                case 'Deployment Control':
                    toolTitle = 'Deployment Lifecycle';
                    toolsHtml = `
                        <p class="text-sm text-gray-400 mb-4">Critical controls for the deployment pipeline.</p>
                        <div class="space-y-3">
                            <button onclick="console.log('Action: Trigger Rollback for ${entryId}')" class="tool-btn bg-red-600 hover:bg-red-700">Trigger Rollback (v1.2)</button>
                            <button onclick="console.log('Action: Pause Auto-Update for ${entryId}')" class="tool-btn bg-yellow-600 hover:bg-yellow-700">Pause Auto-Update</button>
                        </div>
                    `;
                    break;
                case 'AI/LLM Hub':
                    toolTitle = 'Model Management';
                    toolsHtml = `
                        <p class="text-sm text-gray-400 mb-4">Tools for AI model fine-tuning and resource allocation.</p>
                        <div class="space-y-3">
                            <button onclick="console.log('Action: Retrain Model for ${entryId}')" class="tool-btn bg-teal-600 hover:bg-teal-700">Retrain Model with New Data</button>
                            <button onclick="console.log('Action: Check GPU Status for ${entryId}')" class="tool-btn bg-gray-600 hover:bg-gray-700">Check GPU Cluster Status</button>
                        </div>
                    `;
                    break;
                default:
                    toolsHtml = `<p class="text-gray-500">No specific UI tools defined for this module yet. ID: ${entryId}</p>`;
            }

            return `
                <h3 class="text-xl font-semibold text-white mb-4">${toolTitle}</h3>
                ${toolsHtml}
            `;
        }


        /** Renders the detail view for a specific module, including the data table. */
        function renderModuleDetail(moduleName) {
            const moduleInfo = departmentModules.find(m => m.name === moduleName);
            const data = appData[moduleName] || [];
            
            contentArea.innerHTML = `
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h1 class="text-4xl font-extrabold text-white tracking-tight">${moduleName}</h1>
                    <button onclick="navigate('CreateEntry', { moduleId: '${moduleName}' })" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-lg hover:bg-sky-700 transition duration-150 shadow-md">
                        ${getIconSvg('Plus', 18, 2, 'text-white')}
                        <span class="ml-2">New Entry</span>
                    </button>
                </div>
                <p class="text-gray-400 mb-8">${moduleInfo ? moduleInfo.description : 'Module description not found.'}</p>

                <div class="bg-primary-dark rounded-xl shadow-xl overflow-hidden border border-gray-700">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-800">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Priority</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-gray-800">
                                ${data.length > 0 ? data.map(entry => renderTableRow(entry, moduleName)).join('') : `
                                    <tr>
                                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                            No entries found for this module.
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /** Helper to render a single row in the data table. */
        function renderTableRow(entry, moduleName) {
            const statusClass = {
                'New': 'bg-sky-500 text-sky-100',
                'In Progress': 'bg-yellow-500 text-yellow-900',
                'Completed': 'bg-green-500 text-green-100',
                'On Hold': 'bg-gray-500 text-gray-100',
            }[entry.status] || 'bg-gray-500 text-gray-100';

            const priorityClass = {
                'Low': 'text-green-400',
                'Medium': 'text-yellow-400',
                'High': 'text-orange-400 font-semibold',
                'Urgent': 'text-red-500 font-bold',
            }[entry.priority] || 'text-gray-400';

            return `
                <tr class="hover:bg-gray-700 transition duration-150">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-300">${entry.id}</td>
                    <td class="px-6 py-4 text-sm font-medium text-white max-w-xs truncate">
                        <a href="#" onclick="event.preventDefault(); navigate('ViewEntry', { moduleId: '${moduleName}', entryId: '${entry.id}' })" class="text-sky-400 hover:text-sky-300 transition duration-150">${entry.title}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${entry.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${priorityClass}">${entry.priority}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(entry.created).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteEntry('${moduleName}', '${entry.id}', '${entry.title}')" title="Delete" class="text-red-400 hover:text-red-500 p-1 rounded-md transition duration-150">
                            ${getIconSvg('Trash', 18, 2, 'text-current')}
                        </button>
                    </td>
                </tr>
            `;
        }

        /** Renders the dedicated page for creating a new entry. */
        function renderCreateEntry(moduleName) {
            contentArea.innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <div class="flex items-center mb-6">
                        <button onclick="navigate('ModuleDetail', { moduleId: '${moduleName}' })" 
                                class="flex items-center text-gray-400 hover:text-sky-400 transition duration-150 mr-4">
                            ${getIconSvg('Reply', 20, 2, 'text-current')}
                            <span class="ml-2 hidden sm:inline">Back to ${moduleName}</span>
                        </button>
                        <h1 class="text-4xl font-extrabold text-white tracking-tight">Create New Entry</h1>
                    </div>
                    
                    <div class="bg-primary-dark p-8 rounded-xl shadow-xl border border-gray-700">
                        <p class="text-gray-400 mb-6">Creating a new entry for the **${moduleName}** module.</p>
                        ${renderEntryForm(null, moduleName, false)}
                    </div>
                </div>
            `;

            // Attach form listener dynamically
            document.getElementById('entry-form').addEventListener('submit', handleEntrySubmission);
        }

        /** Helper to render the common entry creation/editing form structure. */
        function renderEntryForm(entry = null, moduleName, isEdit) {
            const entryId = entry ? entry.id : '';
            const title = entry ? entry.title : '';
            const status = entry ? entry.status : 'New';
            const priority = entry ? entry.priority : 'Medium';
            const details = entry ? entry.details : '';
            
            return `
                <form id="entry-form" class="space-y-4">
                    <input type="hidden" id="entry-id-field" value="${entryId}">
                    <input type="hidden" id="entry-module-field" value="${moduleName}">

                    <div>
                        <label for="entry-title" class="block text-sm font-medium text-gray-400">Title / Subject</label>
                        <input type="text" id="entry-title" required value="${title}"
                               class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-white shadow-sm p-3 focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="entry-status" class="block text-sm font-medium text-gray-400">Status</label>
                            <select id="entry-status" required 
                                    class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-white shadow-sm p-3 focus:ring-sky-500 focus:border-sky-500 appearance-none transition duration-150">
                                <option value="New" ${status === 'New' ? 'selected' : ''}>New</option>
                                <option value="In Progress" ${status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Completed" ${status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="On Hold" ${status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                            </select>
                        </div>
                        <div>
                            <label for="entry-priority" class="block text-sm font-medium text-gray-400">Priority</label>
                            <select id="entry-priority" required
                                    class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-white shadow-sm p-3 focus:ring-sky-500 focus:border-sky-500 appearance-none transition duration-150">
                                <option value="Low" ${priority === 'Low' ? 'selected' : ''}>Low</option>
                                <option value="Medium" ${priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="High" ${priority === 'High' ? 'selected' : ''}>High</option>
                                <option value="Urgent" ${priority === 'Urgent' ? 'selected' : ''}>Urgent</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="entry-details" class="block text-sm font-medium text-gray-400">Details</label>
                        <textarea id="entry-details" rows="4" required
                                  class="mt-1 block w-full rounded-md border-gray-600 bg-gray-700 text-white shadow-sm p-3 focus:ring-sky-500 focus:border-sky-500 transition duration-150">${details}</textarea>
                    </div>

                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="button" onclick="navigate('ModuleDetail', { moduleId: '${moduleName}' })" 
                                class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-600 rounded-md hover:bg-gray-500 transition duration-150">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-sky-600 rounded-md hover:bg-sky-700 transition duration-150">
                            ${isEdit ? 'Save Changes' : 'Create New Entry'}
                        </button>
                    </div>
                </form>
            `;
        }
        
        /** Handles form submission for both create and edit operations. */
        function handleEntrySubmission(event) {
            event.preventDefault();

            const form = event.target;
            const entryId = form.querySelector('#entry-id-field').value;
            const moduleName = form.querySelector('#entry-module-field').value;
            const title = form.querySelector('#entry-title').value;
            const status = form.querySelector('#entry-status').value;
            const priority = form.querySelector('#entry-priority').value;
            const details = form.querySelector('#entry-details').value;

            if (!appData[moduleName]) {
                appData[moduleName] = [];
            }
            
            let targetEntryId = entryId;

            if (entryId) {
                // EDIT operation
                const index = appData[moduleName].findIndex(e => e.id === entryId);
                if (index !== -1) {
                    appData[moduleName][index] = { ...appData[moduleName][index], title, status, priority, details };
                    console.log(`Entry ${entryId} updated in ${moduleName}`);
                }
            } else {
                // CREATE operation
                const modulePrefix = moduleName.split(' ').map(s => s[0]).join('').toUpperCase().substring(0, 3);
                targetEntryId = `${modulePrefix}-${Math.floor(Math.random() * 900) + 100}`;
                const newEntry = { id: targetEntryId, title, status, priority, created: Date.now(), details };
                appData[moduleName].push(newEntry);
                console.log(`New entry ${targetEntryId} created in ${moduleName}`);
            }

            // After submission, navigate to the view or the module list
            if (entryId) {
                navigate('ViewEntry', { moduleId: moduleName, entryId: targetEntryId });
            } else {
                navigate('ModuleDetail', { moduleId: moduleName });
            }
        }

        /** Handles entry deletion (using simple console confirmation instead of alert). */
        function deleteEntry(moduleName, entryId, entryTitle) {
            console.warn(`Attempting to delete entry ${entryId} (${entryTitle}).`);
            
            // In a real app, use a custom confirm modal.
            const isConfirmed = true; // Simulating confirmation for demo

            if (isConfirmed) {
                appData[moduleName] = appData[moduleName].filter(e => e.id !== entryId);
                console.log(`Entry ${entryId} deleted.`);
                navigate('ModuleDetail', { moduleId: moduleName }); // Return to module list after delete
            }
        }

        // --- INITIALIZATION ---
        
        window.onload = function() {
            // Set User ID placeholder
            userIdSpan.textContent = currentUserId;

            // Setup Mobile Menu Toggle
            menuToggle.addEventListener('click', openSidebar);

            // Initial rendering
            navigate('Home');
        }
    </script>
</body>
</html>